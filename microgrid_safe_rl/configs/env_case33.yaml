# Training configuration for case33 microgrid
# Focus: Line faults + DER degradation (NO cascades during training)
# Agent must learn: switching to isolate faults + load shedding under generation deficit

env_id: case33

# Episode structure
step_seconds: 5.0
max_steps: 120  # 10 minutes of simulation time

# Voltage limits (pu)
voltage_limits: [0.95, 1.05]

# Power flow convergence
pf_failure_patience: 3

# ============================================================================
# REWARD STRUCTURE - Emphasis on critical load preservation
# ============================================================================
reward_weights:
  # Service rewards (positive) - heavily weighted toward critical loads
  tier1: 20.0              # Critical loads (hospitals, emergency services)
  tier2: 5.0               # Important loads (commercial, municipal)
  tier3: 1.5               # Normal loads (residential)
  
  restore_tier1_delta: 12.0

  # Violations (negative)
  volt_violation: -3.0     # Voltage out of bounds
  thermal_violation: -2.0  # Line overloading
  
  # Operational costs
  switch_cost: -0.03       # Small penalty for switching operations
  
  # Severe penalties
  pf_failure: -100.0       # Power flow divergence
  bound_violation: -25.0   # Exceeding DER generation bound

# ============================================================================
# SAFETY CONSTRAINTS - Prevent unsafe actions
# ============================================================================
safety:
  max_closed_ties: 1            # Maximum tie switches closed (maintain radiality)
  voltage_margin_pu: 0.01       # Safety margin for voltage limits
  loading_margin_pct: 5.0       # Safety margin for thermal limits
  per_step_switch_budget: 1     # Max switches per step (prevent thrashing)
  min_dwell_steps: 2            # Minimum time between switch operations

# ============================================================================
# AGENT CONTROLS - What the agent can manipulate
# ============================================================================
controls:
  allow_generation_control: false   # Agent CANNOT change generator setpoints
  allow_storage_control: false      # Agent CANNOT control battery directly
  allow_switching: true            # Agent CAN open/close switches
  allow_tie_closure: true

# Load shedding capability
enable_setpoint_shedding: true      # Agent CAN shed loads
shed_step: 0.10                     # Shed in 10% increments

# ============================================================================
# OBSERVATION SETTINGS - What the agent sees
# ============================================================================
observation:
  telemetry_latency_steps: 0        # No SCADA delay during training
  include_async_masks: false        # No async action masks
  add_measurement_noise: false      # Clean measurements during training
  noise_std:
    voltage_pu: 0.0
    loading_pct: 0.0

# ============================================================================
# DISTURBANCES - Training scenarios
# ============================================================================

# CASCADE ENGINE - DISABLED FOR TRAINING
cascade:
  enabled: true                  # Keep true

  # A) Initial Seed Faults (Keep enabled)
  seed:
    n_seeds: 1                   # Keep 1 initial random fault
    step_window_frac: [0.05, 0.35]

  # B) Cascading Faults (NOW WEAKLY ENABLED)
  lambda0: 0.1                 # CRITICAL: Very small base rate for cascades
  rho0: 0.90                     # Overload threshold factor start
  alpha: 2.0                     # Overload exponent
  overload_min_pct: 100.0        # Line must be >110% loaded
  min_hold_steps: 1              # Must sustain overload for at least 1 step
  max_additional: 2              # CRITICAL: Allow max 2 *extra* trips after seed
  # Other cascade params (less critical for just weakening)
  betaV: 1.0                     # Voltage penalty factor
  zone_boost: 1.4                # Probability boost for lines near existing faults
  d0: 3.0                        # Proximity distance scale
  per_wave_max: 1                # Max trips per *single* step check
  min_gap_steps: 1               # Min steps between cascade checks
  exclude_bridges: true          # Avoid tripping critical bridge lines if possible
  prob_loading_map: 
    - [115.0, 1.2] # Scale up probability above 115%

# ============================================================================
# STRESS CONDITIONS - System degradation
# ============================================================================

# Global stress - DISABLED (use DER degradation instead)
stress:
  global:
    load_scale_p: 1.0
    load_scale_q: 1.0
    line_rating_scale: 1.0
    gen_cap_scale: 1.0
  
  # Local stress around faults - DISABLED
  local_on_fault:
    enabled: true
    hops: 1
    duration_steps: 10
    p_scale: 1.3
    q_scale: 1.0
    line_rating_scale: 0.80
    on_every_trip: true
    accumulate: false

# ============================================================================
# DER UNAVAILABILITY - Primary training challenge
# ============================================================================
der_unavailability:
  enabled: true                     # ENABLED: Forces load shedding decisions
  
  # Generation deficit range
  p_deficit_frac: [0.20, 0.35]      # 20-35% generation shortage
  # This means: if total load = 3.7 MW, available gen = 2.4-3.0 MW
  # Agent MUST shed 0.7-1.3 MW, prioritizing non-critical loads
  
  # DER scaling parameters
  scaling_range: [0.50, 0.85]       # Scale remaining DERs to 50-85% of baseline
  
  # Random outages
  random_outage_prob: 0.15          # 15% chance of additional DER outage
  max_der_size_mw: 0.8              # Only outage small/medium DERs
  max_disabled: 1                   # At most 1 complete outage per episode

# ============================================================================
# TRAINING PHILOSOPHY
# ============================================================================
# 
# This config creates a focused training environment:
#
# 1. **Line Faults**: Single scripted fault per episode (15-35% into episode)
#    - Agent must identify fault location from observations
#    - Agent must isolate fault by opening appropriate switches
#    - No cascading failures to simplify learning
#
# 2. **DER Degradation**: Insufficient generation (20-35% deficit)
#    - Agent cannot increase generation (controls disabled)
#    - Agent MUST shed loads to balance supply/demand
#    - Reward structure heavily incentivizes preserving tier 1 loads
#
# 3. **Learning Objectives**:
#    - Switching: Isolate faults while maintaining supply to unfaulted areas
#    - Load Shedding: Strategic curtailment (tier 3 → tier 2 → tier 1)
#    - Constraint Satisfaction: Maintain voltage/thermal limits
#    - Speed: Restore critical loads quickly (restore_tier1_delta reward)
#
# ============================================================================